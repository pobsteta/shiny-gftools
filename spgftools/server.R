function(input, output, session) {
  ########### Onglet 00 ##############################################
  output$Essences <- renderUI({
    CodesEssIFN <- gftools::getData("IFNCODE") %>%
      dplyr::filter(donnee %in% "ESPAR")
    if (is.null(CodesEssIFN)) return(NULL)
    items <- unique(CodesEssIFN$libelle)
    names(items) <- items
    selectInput("Essences", "Essences:", multiple = TRUE, items)
  })

  output$plotcsv0 <- renderPlot({
    CodesEssIFN <- gftools::getData("IFNCODE") %>%
      dplyr::filter(donnee %in% "ESPAR")
    input$update00
    if (is.null(input$Essences)) return(NULL)
    if (input$update00 == 0) return(NULL)
    isolate({
      withCallingHandlers(
        {
          shinyjs::html(id = "text00", html = "Go ! ")
          p <- gftools::MapSpeciesSER(essence = CodesEssIFN$code[which(CodesEssIFN$libelle %in% input$Essences)])
        },
        message = function(m) {
          shinyjs::html(id = "text00", html = m$message, add = TRUE)
        },
        warning = function(m) {
          shinyjs::html(id = "text00", html = m$message, add = TRUE)
        }
      )
      p$Carte
    })
  })

  ########### Onglet 01 ##############################################
  output$map <- renderLeaflet({
    input$update01
    if (is.null(input$datazip)) return(NULL)
    if (input$update01 == 0) return(NULL)
    isolate({
      utils::unzip(input$zipfile$datapath, exdir = dirname(input$zipfile$datapath))
      adm <- readOGR(dsn = dirname(input$zipfile$datapath), layer = basename(tools::file_path_sans_ext(input$datazip)), verbose = F)
      adm <- spTransform(adm, CRS("+init=epsg:4326"))
      popup <- paste0("<strong>Name: </strong>", adm$CCOD_FRT)
      leaflet() %>%
        addTiles() %>%
        addPolygons(data = adm, weight = 2, fillColor = "yellow", popup = popup)
    })
  })

  # This function is repsonsible for loading in the selected zip file
  filezipdata <- reactive({
    infile <- input$zipfile
    if (is.null(infile)) return(NULL)
    fileshp <- grep(pattern = ".shp", unlist(lapply(infile$datapath, FUN = function(x) unzip(x, list = TRUE)[, 1])), value = TRUE)
  })

  output$datazip <- renderUI({
    dfzip <- filezipdata()
    if (is.null(dfzip)) return(NULL)
    items <- dfzip
    names(items) <- items
    selectInput("datazip", "Shapefile:", items)
  })

  output$plotzip1 <- renderPlot({
    input$update01
    if (is.null(input$datazip)) return(NULL)
    if (input$update01 == 0) return(NULL)
    isolate({
      validate(
        need(input$seuilnb >= 30, "A seuil nb at 30 or less produces bad statistics!")
      )
      withCallingHandlers(
        {
          shinyjs::html(id = "text01", html = "Go ! ")
          utils::unzip(input$zipfile$datapath, exdir = dirname(input$zipfile$datapath))
          p <- gftools::AccDIFNSER(fichier = paste0(dirname(input$zipfile$datapath), "/", input$datazip), enreg = input$enreg, seuilNb = input$seuilnb, periode = as.double(input$periode))
        },
        message = function(m) {
          shinyjs::html(id = "text01", html = m$message, add = TRUE)
        },
        warning = function(m) {
          shinyjs::html(id = "text01", html = m$message, add = TRUE)
        }
      )
      p$Graphe
    })
  })

  ########### Onglet 02 ##############################################
  
  observeEvent(input$datafile, {
    updateTextInput(session, "nomData", value = substr(input$datafile$name,1,nchar(input$datafile$name)-4))
    updateTabsetPanel(session, "inTabset02", selected = "Graphe")
    })

  observeEvent(input$mercufile, {
    updateTextInput(session, "nomMercu", value = substr(input$mercufile$name,1,nchar(input$mercufile$name)-4))
    updateTabsetPanel(session, "inTabset02", selected = "Graphe")
  })
    
  # fichier des data
  filedata <- reactive({
    datafile <- input$datafile
    if (is.null(datafile)) return(NULL)
    dataf <<- readr::read_tsv(
      datafile$datapath,
      locale = readr::locale(encoding = "UTF-8", decimal_mark = ","),
      readr::cols(essence = readr::col_character(), diam = readr::col_integer(), htot = readr::col_double(), hdec = readr::col_double()),
      col_names = T)
    readr::write_tsv(dataf, fname)
    print(paste("filedata:", fname))
    output$datahot <<- renderRHandsontable({
      rhandsontable(dataf, readOnly = TRUE, width = 280, height = 500) %>%
        hot_cols(rowHeaderWidth = 100) %>%
        hot_table(highlightCol = TRUE, highlightRow = TRUE)
    })
    dataf
  })

  # fichier des mercuriales
  filemercu <- reactive({
    mercufile <- input$mercufile
    if (is.null(mercufile)) return(NULL)
    mercu <<- readr::read_tsv(
      mercufile$datapath,
      locale = readr::locale(encoding = "UTF-8", decimal_mark = ","),
      readr::cols(cdiam = readr::col_integer(), tarif = readr::col_character(), houppier = readr::col_integer(), hauteur = readr::col_double()),
      col_names = T)
    readr::write_tsv(mercu, mname)
    print(paste("filemercu:", mname))
    output$mercuhot <<- renderRHandsontable({
      rhandsontable(mercu, width = 280, height = 500) %>%
        hot_cols(colWidths = 53) %>%
        hot_table(highlightCol = TRUE, highlightRow = TRUE)
    })
    mercu
  })

  output$Essences02 <- renderUI({
    CodesEssIFN <- gftools::getData("IFNCODE") %>%
      dplyr::filter(donnee %in% "ESPAR")
    if (is.null(CodesEssIFN)) return(NULL)
    items <- unique(CodesEssIFN$libelle)
    names(items) <- items
    selectInput("Essences02", "Essences:", multiple = TRUE, items, selected = c("Chene sessile", "Hetre"))
  })

  # select tabpanel Plot when click on update02
  observe({
    input$update02
    updateTabsetPanel(session, "inTabset02", selected = "Graphe")
  })
  
  # select tabpanel Map when click on mappoint
  observe({
    input$mappoint
    updateTabsetPanel(session, "inTabset02", selected = "Map")
  })

  plotdata <- reactive({
    input$update02
    if (input$update02 == 0) return(NULL)
    CodesEssIFN <- gftools::getData("IFNCODE") %>%
        dplyr::filter(donnee %in% "ESPAR")
    isolate({
      withProgress(message = 'Calculs en cours', style = 'notification', value = 0.75, {
        Sys.sleep(0.25)
        withCallingHandlers(
          {
            shinyjs::html(id = "text02", html = "Go ! ")
            p <- gftools::TarifFindSch(
              fichier = fname, mercuriale = mname, enreg = F,
              decemerge = input$Decemerge, classearbremin = input$ClasseInf[1],
              mappoint = input$mappoint, classearbremax = input$ClasseInf[2],
              essence = CodesEssIFN$code[which(CodesEssIFN$libelle %in% input$Essences02)],
              latitude = input$latitude, longitude = input$longitude,
              typvolemerge = input$Volcompare,
              zonecalc = zonecalcul(),
              houppier = mhouppier
            )
          },
          message = function(m) {
            shinyjs::html(id = "text02", html = m$message, add = TRUE)
          },
          warning = function(m) {
            shinyjs::html(id = "text02", html = m$message, add = TRUE)
          }
        )
      })
      incProgress(1)
    })
    mhouppier <<- 'N'
    p
  })

  output$plotcsv1 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (1/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe1
    })
  })

  output$plotcsv2 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (2/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe2
    })
  })

  output$plotcsv3 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (3/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe3
    })
  })

  output$plotcsv4 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (4/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe4
    })
  })

  output$plotcsv5 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (5/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe5
    })
  })
  
  output$plotcsv6 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (6/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe6
    })
  })
  
  output$plotcsv7 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (7/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe7
    })
  })
  
  output$plotcsv8 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (8/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe8
    })
  })
  
  output$plotcsv9 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (9/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe9
    })
  })
  
  output$plotcsv10 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (10/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe10
    })
  })
  
  output$plotcsv11 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (11/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe11
    })
  })
  
  output$plotcsv12 <- renderPlot({
    input$update02
    if (input$update02 == 0) return(NULL)
    isolate({
      withProgress(message = 'Création du graphique (12/12)', style = 'notification', value = 0.5, {
        Sys.sleep(0.25)
        p <- plotdata()
        incProgress(1)
      })
      p$Graphe12
    })
  })

  output$latitude <- renderUI({
    input$mappoint
    frt <- polyfrt()
    numericInput("latitude", "Latitude :", pointclick$clickedMarker$lat)
  })

  output$longitude <- renderUI({
    input$mappoint
    frt <- polyfrt()
    numericInput("longitude", "Longitude :", pointclick$clickedMarker$lng)
  })
  
  outAGC = reactive({
    agc <- agencedata %>%
      filter(grepl(input$dt, iidtn_agc))
    agc$iidtn_agc
  })
  
  outFRT = reactive({
   frt <- forestdata %>%
     filter(ccod_cact == input$agence)
   frt$ccod_frt
  })
  
  outPRF = reactive({
    prf <- parcelledata %>%
      filter(ccod_frt == input$forest, ccod_cact == input$agence)
    prf$ccod_prf
  })
  
  outPST = reactive({
    pst <- pstdata %>%
      filter(grepl(input$agence, ccod_cact))
    pst$ccod_ut
  })
  
  output$pst <- renderUI({
    selectizeInput("pst", NULL, choices = outPST(), multiple = TRUE, 
                   options = list(placeholder = 'Choisir PST'))
  })
  
  outDATA = reactive({
    ssample <- files %>%
      filter(dt == input$dt, agence == input$agence, forest == input$forest, parcelle == input$parcelle)
    if (length(ssample$id) > 0) {
      data <- filed %>%
        filter(sample == ssample$id)
      return(data$name)
    } else {
      return(NULL)
    }
  })
  
  outMERCU = reactive({
    mfile <- filed %>%
      filter(grepl(input$listedata, name))
    if (length(mfile$id) > 0) {
      mercu <- filem %>%
        filter(id %in% mfile$id)
      if (length(mercu$id) > 0) {
        return(mercu$name)
      } else {
        return(NULL)
      }
    } else {
      return(NULL)
    }
  })
  
  observeEvent(input$parcelle, {
    updateSelectInput(session, "listedata", choices = c('Choisir DATA' = '', outDATA()))
  })
  
  observeEvent(input$listedata, {
    if (!is.null(input$listemercu)) {
      # recherche l identifiant du sample
      dt <- dtdata %>% filter(iidtn_dt == input$dt)
      frt <- forestdata %>% filter(ccod_frt == input$forest)
      agc <- agencedata %>% filter(iidtn_agc == input$agence)
      prf <- parcelledata %>% filter(ccod_cact == input$agence, ccod_frt == input$forest, ccod_prf == input$parcelle)
      query <- sprintf(
        "SELECT id FROM sample WHERE dt=%s AND agence=%s AND forest=%s AND parcelle=%s",
        dt$id, agc$id, frt$id, prf$id
      )
      sid <- loadData(query = query)
      if (!is.null(sid)) {
        # recherche l identifiant du datafile
        query <- sprintf(
          "SELECT id FROM filedata WHERE sample=%s AND name='%s'",
          sid[[1]], input$listedata
        )
        did <- loadData(query = query)
        # recherche les data du datafile si existe
        if (!is.null(did)) {
            if (nrow(did) > 0) {
              query <- sprintf(
                "SELECT essence, diam, htot, hdec FROM datadata WHERE filedata=%s",
                did[[1]]
              )
              ddata <- loadData(query = query)
              if (!is.null(ddata)) {
                updateTextInput(session, "nomData", value = ddata)
                output$datahot <<- renderRHandsontable({
                  rhandsontable(ddata, width = 280, height = 500) %>%
                    hot_cols(colWidths = 53) %>%
                    hot_table(highlightCol = TRUE, highlightRow = TRUE)
                })
              }
            } else {
              return(NULL)
            }
        }
      }
      updateSelectInput(session, "listemercu", choices = c('Choisir MERCU' = '', outMERCU()))
    } else {
      return(NULL)
    }
  })
  
  observeEvent(input$listemercu, {
    if (!is.null(input$listemercu)) {
      # recherche l identifiant du sample
      dt <- dtdata %>% filter(iidtn_dt == input$dt)
      frt <- forestdata %>% filter(ccod_frt == input$forest)
      agc <- agencedata %>% filter(iidtn_agc == input$agence)
      prf <- parcelledata %>% filter(ccod_cact == input$agence, ccod_frt == input$forest, ccod_prf == input$parcelle)
      query <- sprintf(
        "SELECT id FROM sample WHERE dt=%s AND agence=%s AND forest=%s AND parcelle=%s",
        dt$id, agc$id, frt$id, prf$id
      )
      sid <- loadData(query = query)
      if (!is.null(sid)) {
        # recherche l identifiant du datafile
        query <- sprintf(
          "SELECT id FROM filedata WHERE sample=%s AND name='%s'",
          sid[[1]], input$listedata
        )
        did <- loadData(query = query)
        if (!is.null(did)) {
          # recherche l identifiant du filemercuriale selectionne
          query <- sprintf(
            "SELECT id FROM filemercuriale WHERE name='%s' AND filedata=%s",
            input$listemercu, did[[1]]
          )
          fid <- loadData(query = query)
          # recherche les data du filemercuriale si existe
          if (!is.null(fid)) {
            if (nrow(fid) > 0) {
              query <- sprintf(
                "SELECT cdiam, tarif, houppier, hauteur FROM datamercuriale WHERE filemercuriale=%s",
                fid[[1]]
              )
              mercu <- loadData(query = query)
              if (!is.null(input$listemercu)) {
                updateTextInput(session, "nomMercu", value = as.character(input$listemercu))
                output$mercuhot <<- renderRHandsontable({
                  rhandsontable(mercu, width = 280, height = 500) %>%
                    hot_cols(colWidths = 53) %>%
                    hot_table(highlightCol = TRUE, highlightRow = TRUE)
                })
              }
            } else {
              return(NULL)
            }
          }
        } else {
          return(NULL)
        }
      }
    }
  })
  
  observeEvent(input$dt, {
    updateSelectInput(session, "agence", choices = c(Choisir='', outAGC()))
  })
  
  observeEvent(input$agence, {
    updateSelectInput(session, "forest", choices = c(Choisir='', outFRT()))
  })
  
  observeEvent(input$forest, {
    updateSelectInput(session, "parcelle", choices = c(Choisir='', outPRF()))
  })
  
  polydt <- reactive({
    polydt <- dtdata %>%
      filter(iidtn_dt == input$dt) 
    polydt
  })
  
  observeEvent(input$dt, {
    dt <- polydt()
    if (!is.null(input$dt)) {
      dt <- st_centroid(dt) %>%
        st_geometry()
      leafletProxy('map0201') %>%
        setView(lat = st_coordinates(dt)[2], lng = st_coordinates(dt)[1], zoom = 8)
    }
  })
  
  polyagc <- reactive({
    polyagc <- agencedata %>%
      filter(iidtn_agc == input$agence) 
    polyagc
  })
  
  observeEvent(input$agence, {
    agc <- polyagc()
    if (!is.null(input$agence)) {
      agc <- st_centroid(agc) %>%
        st_geometry()
      leafletProxy('map0201') %>%
        setView(lat = st_coordinates(agc)[2], lng = st_coordinates(agc)[1], zoom = 10)
    }
  })
  
  polyfrt <- reactive({
    polyfrt <- forestdata %>%
      filter(ccod_frt == input$forest) 
    polyfrt
  })
  
  observeEvent(input$forest, {
    frt <- polyfrt()
    if (!is.null(input$forest)) {
      frt <- st_centroid(frt) %>%
        st_geometry()
      leafletProxy('map0201') %>%
        setView(lat = st_coordinates(frt)[2], lng = st_coordinates(frt)[1], zoom = 12)
    }
  })
  
  polyprf <- reactive({
    polyfrt <- parcelledata %>%
      filter(ccod_prf == input$parcelle, ccod_frt == input$forest)
    polyfrt
  })
  
  observeEvent(input$parcelle, {
    prf <- polyprf()
    if (!is.null(input$parcelle)) {
      prf <- st_centroid(prf) %>%
        st_geometry()
      leafletProxy('map0201') %>%
        setView(lat = st_coordinates(prf)[2], lng = st_coordinates(prf)[1], zoom = 14)
    }
  })
  
  polypst <- reactive({
    polypst <- pstdata %>%
      filter(ccod_ut == input$pst)
    polypst
  })

  observeEvent(input$pst, {
    pst <- polypst()
    if (!is.null(input$pst)) {
      pst <-st_centroid(st_convex_hull(st_union(pst))) %>%
        st_geometry()
      leafletProxy('map0201') %>%
        setView(lat = st_coordinates(pst)[2], lng = st_coordinates(pst)[1], zoom = 10)
    }
  })

  output$map0201 <- renderLeaflet({
    agc <- polyagc()
    popupagc <- paste0("<strong>", agc$iidtn_agc, " - ", agc$llib_agc, "</strong>")
    frt <- polyfrt()
    popupfrt <- paste0("<strong>", frt$llib2_frt, "</strong>")
    prf <- polyprf()
    popupprf <- paste0("<strong>Parcelle : </strong>", prf$ccod_prf)
    leaflet() %>%
      setView(lat = 47.08, lng = 5.68, zoom = 6) %>%
      addTiles() %>%
      addPolygons(data = polyfrt(), weight = 2, color = 'green', fillColor = 'green', popup = popupfrt, group = "Forêt") %>%
      addPolygons(data = polyprf(), weight = 2, color = 'red', fillColor = 'red', popup = popupprf, group = "Parcelle") %>%
      addLayersControl(overlayGroups = c("Forêt", "Parcelle"), options = layersControlOptions(collapsed = TRUE))
  })
  
  pointclick <- reactiveValues(clickedMarker = NULL)
  
  output$map0202 <- renderLeaflet({
    input$update02
    if (input$update02 == 0) return(NULL)
    if (is.null(pointclick$clickedMarker$lat)) return(NULL)
    p <- plotdata()
    if (!is.null(p$Zone) | !is.null(p$Placettes)) {
      zonemap <- sf::st_transform(p$Zone, crs = 4326)
      placettesmap <- sf::st_transform(p$Placettes, crs = 4326)
    } else {
      return(NULL)
    }
    popupzone <- paste0("<strong>", p$Zone$couche, " (id/nom) : </strong>", p$Zone$id, "/", p$Zone$name)
    popupplacettes <- paste0("<strong>Année : </strong>", p$Placettes$yrs, " - idp : ", p$Placettes$idp)
    leaflet() %>%
      setView(lat = pointclick$clickedMarker$lat, lng = pointclick$clickedMarker$lng, zoom = input$map0201_zoom - 3) %>%
      addTiles() %>%
      addPolygons(data = zonemap, weight = 2, fillColor = "yellow", popup = popupzone, group = "Zone de calcul") %>%
      addCircles(data = placettesmap, popup=popupplacettes, weight = 3, radius = 60, color = '#ff00e6', fill = TRUE, stroke = TRUE, fillOpacity = 0.1, group = "Placette IFN") %>%
      addMarkers(lat = pointclick$clickedMarker$lat, lng = pointclick$clickedMarker$lng, popup = "Localisation du calcul !") %>%
      addLayersControl(overlayGroups = c("Zone de calcul", "Placette IFN"), options = layersControlOptions(collapsed = TRUE))
  })
  
  zonecalcul <- eventReactive({
    input$update02
  }, {
      txt <- paste0("'", input$zonecalc, "' as couche, ")
      if (input$zonecalc == 'ser') {
        txt <- paste0(txt, " name, id,")
      } else if (input$zonecalc == 'rn250') {
        txt <- paste0(txt, " regionn as name, id,")
      } else if (input$zonecalc == 'rf250') {
        txt <- paste0(txt, " regiond as name, id,")
      } else if (input$zonecalc == 'pst') {
        txtpst <- paste0("WITH w2 AS (WITH w1 AS (SELECT clib_pst AS name, ccod_ut AS id, geom FROM pst WHERE ccod_ut::integer IN (", paste(input$pst, collapse=","), 
                         ")) SELECT name, id, st_union(geom) AS geom FROM w1 GROUP BY name, id)")
      }
      if (input$zonecalc != 'pst') {
        BDDQueryONF(query = paste0("SELECT ", txt, " geom FROM ", 
                                 input$zonecalc, " s WHERE st_dwithin(st_transform(st_setsrid(st_makepoint(",
                                 pointclick$clickedMarker$lng, ",",
                                 pointclick$clickedMarker$lat, "),4326),2154), s.geom,0)")) %>%
        sf::st_transform(crs=2154)
      } else {
        BDDQueryONF(query = paste0(txtpst, " SELECT ", txt, "string_agg(name, ',') AS name, string_agg(id, ',') AS id, st_union(geom) AS geom FROM w2")) %>%
          sf::st_transform(crs=2154)
      }
  })

  observeEvent(input$map0201_click, {
    pointclick$clickedMarker <- input$map0201_click
    leafletProxy("map0201") %>%
      clearMarkers() %>%
      addMarkers(
        lat = pointclick$clickedMarker$lat, lng = pointclick$clickedMarker$lng,
        popup = paste0("lat=", pointclick$clickedMarker$lat, ", lng=", pointclick$clickedMarker$lng)
      ) %>%
      setView(lng = pointclick$clickedMarker$lng, lat = pointclick$clickedMarker$lat, input$map0201_zoom)
  })
  
  # Resvol
  output$Resvol <- renderText({
    input$update02
    if (input$update02 == 0) return(NULL)
    if (is.null(filemercu())) return(NULL)
    if (is.null(filedata())) return(NULL)
    withProgress(message = 'Comparaison des résultats', style = 'notification', value = 0.5, {
      Sys.sleep(0.25)
      resv <- gftools::describeBy(tabdata(), group = tabdata()$essence)
      incProgress(1)
    })
    Txt <- ""
    for (r in length(resv):1) {
      Txt <- paste0(
        "Pour l'essence ", names(resv[r]), ", l'estimation ONF cube ", round(100 * (resv[[r]]["L_VbftigCom", "sum"] / resv[[r]]["E_VbftigCom", "sum"] - 1), 0),
        "% du volume bois fort tige commercial EMERGE et ", round(100 * (resv[[r]]["L_Vbftot7cm", "sum"] / resv[[r]]["E_Vbftot7cm", "sum"] - 1), 0), 
        "% du volume bois fort total EMERGE :\n- le volume bois fort tige commercial (L_VbftigCom) LOCAL de l'échantillon est de ", resv[[r]]["L_VbftigCom", "sum"],
        " m3, le volume bois fort tige commercial (E_VbftigCom) EMERGE de l'échantillon est de ", resv[[r]]["E_VbftigCom", "sum"],
        " m3,\n- le volume houppier (L_VHouppiers) LOCAL de l'échantillon est de ", resv[[r]]["L_VHouppiers", "sum"],
        " m3, le volume houppier (E_VHouppiers) EMERGE de l'échantillon est de ",
        round(resv[[r]]["E_Vbftot7cm", "sum"] - resv[[r]]["E_VbftigCom", "sum"], 2),
        " m3,\n- soit un pourcentage de houppiers moyen LOCAL de l'échantillon (L_PHouppiers) de ",
        round(100 * resv[[r]]["L_PHouppiers", "mean"], 0),
        "%, et un pourcentage de houppiers moyen EMERGE de l'échantillon (E_PHouppiers) de ",
        round(100 * resv[[r]]["E_PHouppiers", "mean"], 0), "%.\n", Txt
      )
    }
    return(Txt)
  })
  
  # tableau des donnees calculees
  tabdata <- reactive({
    input$update02
    if (input$update02 == 0) return(NULL)
    plotdata()$Tableau1
  })

  # Generate a summary of the result
  output$summarycsv <- renderPrint({
    input$update02
    if (input$update02 == 0) return(NULL)
    if (is.null(filemercu())) return(NULL)
    if (is.null(filedata())) return(NULL)
    withProgress(message = 'Tableau des résultats', style = 'notification', value = 0.5, {
      Sys.sleep(0.25)
      resv <- gftools::describeBy(tabdata(), group = tabdata()$essence)
      incProgress(1)
    })
    resv
  })

  output$show_vars <- renderUI({
    data <- tabdata()
    checkboxGroupInput("show_vars", "Colonnes à afficher :",
                       names(data), selected = names(data))
  })

  # Generate an HTML table view of the data
  output$tablecsv1 <- DT::renderDataTable({
    data <- tabdata()
    DT::datatable(data[, input$show_vars, drop = FALSE], options = list(pageLength = 10))
  })
  
  # save data
  output$saveBtnData <- downloadHandler( 
    # Nom par défaut :
    filename = function() {
      paste0("Data_", Sys.Date(), ".csv")
    },
    content = function(file) {
      write.csv2(tabdata(), file, row.names = FALSE) 
    }
  )
  
  # filedata --- fichier des donnees -----
  observeEvent(input$saveBtnDataBDD, {
    # enregistre ou met à jour sample
    dt <- dtdata %>% filter(iidtn_dt == input$dt)
    frt <- forestdata %>% filter(ccod_frt == input$forest)
    agc <- agencedata %>% filter(iidtn_agc == input$agence)
    prf <- parcelledata %>% filter(ccod_cact == input$agence, ccod_frt == input$forest, ccod_prf == input$parcelle)
    query <- sprintf(
      "INSERT INTO sample (create_date, create_uid, dt, agence, forest, parcelle) SELECT now(), 1, %s, %s, %s, %s 
      WHERE NOT EXISTS (SELECT 1 FROM sample WHERE dt=%s AND agence=%s AND forest=%s AND parcelle=%s)",
      dt$id, agc$id, frt$id, prf$id,
      dt$id, agc$id, frt$id, prf$id
    )
    saveData(query = query)
    # recherche l identifiant du sample
    query <- sprintf(
      "SELECT id FROM sample WHERE dt=%s AND agence=%s AND forest=%s AND parcelle=%s",
      dt$id, agc$id, frt$id, prf$id
    )
    sid <- loadData(query = query)
    # enregistre ou met a jour filedata
    query <- sprintf(
      "INSERT INTO filedata (create_date, create_uid, name, sample) SELECT now(), 1, '%s', %s
      WHERE NOT EXISTS (SELECT 1 FROM filedata WHERE name='%s' AND sample=%s)",
      input$nomData, sid[[1]],
      input$nomData, sid[[1]]
    )
    saveData(query = query)
    # recherche l identifiant du filedata juste cree
    query <- sprintf(
      "SELECT id FROM filedata WHERE name='%s' AND sample=%s",
      input$nomData, sid[[1]]
    )
    fid <- loadData(query = query)
    # enregistre ou met a jour les data
    DF <- as.data.frame(filedata()) %>%
      mutate(create_date = toString(as.POSIXlt(Sys.time(), "Europe/Paris")), create_uid = 1, filedata = fid[[1]])
    # efface les data existantes
    query <- sprintf(
      "DELETE FROM datadata WHERE filedata=%s",
      fid[[1]]
    )
    delData(query = query)
    # insert les nouvelles data
    insertData("datadata", DF)
    # on met a jour la liste deroulante data csv
    query <- sprintf(
      "SELECT * FROM filedata WHERE sample=%s",
      sid[[1]]
    )
    filed <<- loadData(query = query)
    updateSelectInput(session, "listedata", choices = c('Choisir DATA' = '', filed$name))
  })
  
  observe({
    # enregistre la mercuriale
    # apres chaque changement
    if (!is.null(input$mercuhot)) {
      readr::write_tsv(hot_to_r(input$mercuhot), mname)
      print(paste("observe:", mname))
    }
  })
  
  # save mercuriale
  output$saveBtnMercu <- downloadHandler(
    # Nom par défaut :
    filename = function() {
      paste0('Mercu_', Sys.Date(), '.csv')
    },
    content = function(file) {
      if (!is.null(input$mercuhot)) {
        write.csv(as.data.frame(hot_to_r(input$mercuhot)), file, row.names = FALSE) 
      } else {
        write.csv(filemercu(), file, row.names = FALSE)
      }
    }
  )
  
  # filemercuriale --- fichier mecuriale -------
  observeEvent(input$saveBtnMercuBDD, {
    # recherche l identifiant du sample
    dt <- dtdata %>% filter(iidtn_dt == input$dt)
    frt <- forestdata %>% filter(ccod_frt == input$forest)
    agc <- agencedata %>% filter(iidtn_agc == input$agence)
    prf <- parcelledata %>% filter(ccod_cact == input$agence, ccod_frt == input$forest, ccod_prf == input$parcelle)
    query <- sprintf(
      "SELECT id FROM sample WHERE dt=%s AND agence=%s AND forest=%s AND parcelle=%s",
      dt$id, agc$id, frt$id, prf$id
    )
    sid <- loadData(query = query)
    # recherche l identifiant du datafile
    query <- sprintf(
      "SELECT id FROM filedata WHERE sample=%s AND name='%s'",
      sid[[1]], input$listedata
    )
    did <- loadData(query = query)
    # enregistre ou met a jour filemercuriale
    query <- sprintf(
      "INSERT INTO filemercuriale (create_date, create_uid, name, filedata) SELECT now(), 1, '%s', %s
      WHERE NOT EXISTS (SELECT 1 FROM filemercuriale WHERE name='%s' AND filedata=%s)",
      input$nomMercu, did[[1]],
      input$nomMercu, did[[1]]
    )
    saveData(query = query)
    # recherche l identifiant du filemercuriale juste cree
    query <- sprintf(
      "SELECT id FROM filemercuriale WHERE name='%s' AND filedata=%s",
      input$nomMercu, did[[1]]
    )
    fid <- loadData(query = query)
    # enregistre ou met a jour les data
    if (!is.null(input$mercuhot)) {
      DF <- hot_to_r(input$mercuhot)
    } else {
      DF <- mercu
    }
    DF <- as.data.frame(DF) %>%
      mutate(create_date = toString(as.POSIXlt(Sys.time(), "Europe/Paris")), create_uid = 1, filemercuriale = fid[[1]])
    # efface les data existantes
    query <- sprintf(
      "DELETE FROM datamercuriale WHERE filemercuriale=%s",
      fid[[1]]
    )
    delData(query = query)
    # insert les nouvelles data
    insertData("datamercuriale", DF)
    # on met a jour la liste deroulante mercu csv
    query <- sprintf(
      "SELECT * FROM filemercuriale WHERE filedata=%s",
      did[[1]]
    )
    filem <<- loadData(query = query)
    updateSelectInput(session, "listemercu", choices = c('Choisir MERCU' = '', filem$name))
  })
  
  # Samnbtig
  Samnbtig <- reactive({
    if (!is.null(input$datahot)) {
      as.data.frame(hot_to_r(input$datahot))
    } else if (!is.null(filedata())) {
      filedata()
    } else {
      return(NULL)
    }
  })
  
  # Affichage Samnbtig
  output$Samnbtig <- renderText({
    if (is.null(Samnbtig())) return(NULL)
    nbtig <- nrow(Samnbtig())
    nbess <- unique(Samnbtig()$essence)
    listess <- paste(nbess, collapse = ", ")
    Txt <- paste0(
      " L'échantillon contient ", nbtig, " tiges désignées et ", length(nbess), " essences : ", listess, "."
    )
  })
  
  # Tartypvol
  Tartypvol <- reactive({
    if (!is.null(input$mercuhot)) {
      as.data.frame(hot_to_r(input$mercuhot))
    } else if (!is.null(filemercu())) {
      filemercu()
    } else {
      return(NULL)
    }
  })
  
  # Affichage Tartypvol
  output$Tartypvol <- renderText({
    if (is.null(Tartypvol())) return(NULL)
    Tar <- unique(Tartypvol()$tarif)
    Tar <- Tar[!is.na(Tar)]
    Tab <- ListTarONF3[which(ListTarONF3$sibois %in% Tar), c("ess", "type_v", "contexte", "defvol", "dmin", "dmax", "hmin", "hmax", "entr1", "entr2", "sibois")]
    Txt <- paste0(
      Tab$sibois, " (", Tab$contexte, "), est un tarif pour les essences (", Tab$ess, "), pour les diamètres de ", Tab$dmin, " à ", Tab$dmax,
      " cm, pour les hauteurs de ", Tab$hmin, " à ", Tab$hmax, " m,\n nécessite ", Tab$entr1, " et ", Tab$entr2, " et renvoi un ", Tab$defvol, " (", Tab$type_v, ").\n"
    )
  })
  
  # essences presentes dans l'echantillon
  outESPAR = reactive({
    input$update02
    if (input$update02 == 0) return(NULL)
    c('Toutes', pull(plotdata()$Tableau2, essence))
  })
  
  # affichage des essences
  observeEvent(input$update02, {
    updateSelectInput(session, "espar", selected = 'Toutes', choices = c(Choisir='', outESPAR()))
  })
  
  # tableau des mercuriales
  outRESHOT = eventReactive(input$espar, {
    if (!is.null(plotdata())) {
      res1 <- plotdata()$Tableau1 %>%
        group_by(Classe, essence) %>%
        summarise_at(c("E_PHouppiers"), funs(mean)) %>%
        mutate_at(c("E_PHouppiers"), funs(as.integer(100*round(., 2)))) 
      res2 <- plotdata()$Tableau1 %>%
        group_by(Classe) %>%
        summarise_at(c("E_PHouppiers"), funs(mean)) %>%
        mutate_at(c("E_PHouppiers"), funs(as.integer(100*round(., 2)))) %>%
        mutate(essence='Toutes')
      bind_rows(res1,res2) %>%
        filter(essence == input$espar)
    }
  })
  
  # affichage du fichier des mercuriales
  output$reshot = renderRHandsontable({
    if (!is.null(outRESHOT())) {
      DF = outRESHOT()
    } else {
      return(NULL)
    }
    rhandsontable(DF, width = 300, height = 500) %>%
      hot_cols(rowHeaderWidth = 100) %>%
      hot_table(highlightCol = TRUE, highlightRow = TRUE)
  })
  
  # numtarif
  observeEvent({
    input$tarif
    input$espar
    }, {
    if (!is.null(input$tarif) & !is.null(input$espar) & !(is.null(plotdata()$Tableau2))) {
      res1 <- plotdata()$Tableau2
      res2 <- res1 %>%
         summarise_at(c("SchR","SchL","Alg"), funs(mean)) %>%
         mutate(essence = 'Toutes')
      res <- bind_rows(res2,res1)
      arrondi <- if (is.numeric(res[[which(res$essence == input$espar), as.integer(input$tarif)]])) {round(res[[which(res$essence == input$espar), as.integer(input$tarif)]],0)} else ''
      updateSelectInput(session, "numtarif", selected = arrondi)
    }
  })
  
  # bouton transmercu
  observeEvent(input$transmercu, {
    if (!is.null(input$reshot)) {
      DF = hot_to_r(input$reshot) %>%
        rename(cdiam = Classe) %>%
        mutate(tarif = paste0(names(listetarif)[as.integer(input$tarif)], formatC(as.integer(input$numtarif), width=2, flag="0")), 
               hauteur = 0,
               houppier = round(100 * E_PHouppiers / (100 + E_PHouppiers), 0))
    } else if (!is.null(outRESHOT())) {
      DF = outRESHOT() %>%
        rename(cdiam = Classe) %>%
        mutate(tarif = paste0(names(listetarif)[as.integer(input$tarif)], formatC(as.integer(input$numtarif), width=2, flag="0")), 
               hauteur = 0,
               houppier = round(100 * E_PHouppiers / (100 + E_PHouppiers), 0))
    } else {
      return(NULL)
    }
    mercu <<- DF[, c("cdiam","tarif","houppier","hauteur")]
    mhouppier <<- 'O'
    output$mercuhot <<- renderRHandsontable({
      rhandsontable(mercu, width = 280, height = 500) %>%
        hot_cols(colWidths = 53) %>%
        hot_table(highlightCol = TRUE, highlightRow = TRUE)
    })
    readr::write_tsv(mercu, mname)
    print(paste("filemercu2:", mname))
    mercu
  })
  
  # tableau des donnees calculees
  tablocalmercu <- reactive({
    input$update022
    if (input$update022 == 0) return(NULL)
    query <- sprintf(
      "SELECT exercice, agence, ess AS essence, diam, haut, nb, tahd AS l_phouppiers, tacomd, volcu AS l_vbftigcom, volcu*(tahd/100.0) AS l_vhouppiers, 
      volcu*(1+tahd/100.0) AS l_vbftot7cm FROM datacab WHERE agence='%s' AND exercice=%s AND diam>0 AND tacomd!='0'",
      input$agence, input$exercice
    )
    res <- loadData(query = query)
    if (!is.null(res)) {
      if (nrow(res) > 0) {
        mer <- readr::read_tsv(
          mname,
          locale = readr::locale(encoding = "UTF-8", decimal_mark = "."),
          readr::cols(cdiam = readr::col_integer(), tarif = readr::col_character(), houppier = readr::col_integer(), hauteur = readr::col_double()),
          col_names = T) %>%
          filter(!is.na(tarif))
        res <- res %>%
          mutate(classe = floor(diam / 5 + 0.5) * 5) %>%
          inner_join(mer, by = c(classe = "cdiam"))
        res <- data.table(res)
        res[, e_vbftot7cm := TarONF3(Tar = tarif, cdiam = diam, entr1 = diam, entr2 = haut, details = FALSE), by = tarif]
        tab <- res %>%
          mutate(
            e_vhouppiers = e_vbftot7cm * houppier / 100,
            e_vbftigcom = e_vbftot7cm - e_vhouppiers,
            e_phouppiers = houppier / 100
          )
        tab.r <- tab %>%
          mutate(tl_vbftigcom = l_vbftigcom * nb, tl_vhouppiers = l_vhouppiers * nb, te_vbftigcom = e_vbftigcom * nb, te_vhouppiers = e_vhouppiers * nb) %>%
          group_by(exercice,agence,essence,classe) %>%
          summarise_at(c("tl_vbftigcom", "tl_vhouppiers", "te_vbftigcom", "te_vhouppiers", "nb"), sum, na.rm=TRUE)
        tab.s <- tab %>%
          mutate(tl_vbftigcom = l_vbftigcom * nb, tl_vhouppiers = l_vhouppiers * nb, te_vbftigcom = e_vbftigcom * nb, te_vhouppiers = e_vhouppiers * nb) %>%
          group_by(exercice,agence,classe) %>%
          summarise_at(c("tl_vbftigcom", "tl_vhouppiers", "te_vbftigcom", "te_vhouppiers", "nb"), sum, na.rm=TRUE) %>%
          mutate(essence="Toutes")
        tab1 <- bind_rows(tab.r, tab.s)
        
        tab.t <- reshape2::melt(tab1, id.vars = c("exercice","agence","essence","classe"), measure.vars = c("tl_vbftigcom", "tl_vhouppiers", "te_vbftigcom", "te_vhouppiers")) %>%
          mutate(Type = substr(variable, 1, 2), variable = substr(variable, 4, 12))
        names(tab.t) <- c("exercice","agence","essence","classe","tarif","vol","type")
        tab.t$type[which(tab.t$type=='tl')] <- "LOCAL"
        tab.t$type[which(tab.t$type=='te')] <- "EMERCU"
        tab.t$tarif[which(tab.t$tarif=='vhouppier')] <- "VHouppiers"
        tab.t$tarif[which(tab.t$tarif=='vbftigcom')] <- "VbftigCom"
        out <- list(tab1, tab.t)
        names(out) <- c("Tableau1", "Tableau2")
        return(out)
      }
    }
  })
  
  # Affichage du graphe de comparaison des volumes agences
  output$plotdatacab <- renderPlot({
    if (!is.null(tablocalmercu()$Tableau2)) {
      if (is.null(input$Essences03)) return (NULL)
      tab <- tablocalmercu()$Tableau2 %>%
          filter(essence %in% input$Essences03)
      ggplot(tab, aes(x = type, y = vol, group = type, fill=type, alpha = tarif)) +
        scale_fill_manual(values = c("red", "darkgreen")) +
        geom_bar(stat="identity", position = "stack") +
        facet_grid(agence + essence ~ classe) +
        scale_alpha_manual(values=c(1,0.1))
    }
  })
  
  # localmercu
  output$localmercu <- renderText({
    input$update022
    if (input$update022 == 0) return(NULL)
    tab <- tablocalmercu()$Tableau1 %>%
      filter(essence %in% input$Essences03)
    withProgress(message = 'Comparaison des résultats', style = 'notification', value = 0.5, {
      Sys.sleep(0.25)
      resv <- gftools::describeBy(tab, group = tab$essence)
      incProgress(1)
    })
    print(resv)
    Txt <- paste0("- AGENCE ", input$agence, ", EXERCICE ", input$exercice , " -\n")
    for (r in length(resv):1) {
      Txt <- paste0(Txt, 
        "Pour l'essence ", names(resv[r]), " :\n - l'estimation LOCAL cube ", round(100 * ((resv[[r]]["tl_vbftigcom", "sum"] + resv[[r]]["tl_vhouppiers", "sum"]) / (resv[[r]]["te_vbftigcom", "sum"] + resv[[r]]["te_vhouppiers", "sum"])- 1), 0),
        "% du volume bois fort total decoupe 7cm EMERCU, ", round(100 * (resv[[r]]["tl_vbftigcom", "sum"] / resv[[r]]["te_vbftigcom", "sum"] - 1), 0),
        "% du volume bois fort tige EMERCU et ", round(100 * (resv[[r]]["tl_vhouppiers", "sum"] / resv[[r]]["te_vhouppiers", "sum"] - 1), 0),
        "% du volume houppiers EMERCU :\n- le volume bois fort tige commercial LOCAL est de ", round(resv[[r]]["tl_vbftigcom", "sum"], 0),
        " m3, le volume bois fort tige commercial EMERCU est de ", round(resv[[r]]["te_vbftigcom", "sum"], 0),
        " m3,\n- le volume houppier LOCAL est de ", round(resv[[r]]["tl_vhouppiers", "sum"], 0),
        " m3, le volume houppier EMERCU est de ", round(resv[[r]]["te_vhouppiers", "sum"], 0), " m3.\n"
      )
    }
    return(Txt)
  })
  
  output$Essences03 <- renderUI({
    if (input$update022 == 0) return(NULL)
    items <- unique(tablocalmercu()$Tableau1$essence)
    names(items) <- items
    selectInput("Essences03", " ", multiple = TRUE, items, selected = c("Toutes"))
  })
  
  ########## Onglet 03 ##############################################
  # This function is repsonsible for loading in the selected zip file
  filezipdata03 <- reactive({
    infile <- input$zipfile03
    if (is.null(infile)) return(NULL)
    fileshp <- grep(pattern = ".shp", unlist(lapply(infile$datapath, FUN = function(x) unzip(x, list = TRUE)[, 1])), value = TRUE)
  })

  output$datazip03 <- renderUI({
    dfzip <- filezipdata03()
    if (is.null(dfzip)) return(NULL)
    items <- dfzip
    names(items) <- items
    selectInput("datazip03", "Shapefile:", items)
  })

  # Generate an HTML table view of the data ----
  tab03 <- reactive({
    input$update03
    if (is.null(input$datazip03)) return(NULL)
    if (input$update03 == 0) return(NULL)
    isolate({
      validate(
        need(input$seuilnb03 >= 30, "A seuil nb at 30 or less produces bad statistics!")
      )
      withCallingHandlers(
        {
          shinyjs::html(id = "text03", html = "Go ! ")
          utils::unzip(input$zipfile03$datapath, exdir = dirname(input$zipfile03$datapath))
          p <- gftools::TarifIFNSER(
            fichier = paste0(dirname(input$zipfile03$datapath), "/", input$datazip03), enreg = input$enreg03, seuilNb = input$seuilnb03,
            seuilCircf = as.integer(input$seuilcirc * pi), res = input$res, distmax = input$distmax
          )
        },
        message = function(m) {
          shinyjs::html(id = "text03", html = m$message, add = TRUE)
        }
      )
      p$Tableau
    })
  })

  output$table03 <- DT::renderDataTable(
    tab03(), options = list(
      pageLength = 15
    ), server = FALSE
  )
}
